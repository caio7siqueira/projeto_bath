generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                     String                  @id @default(uuid())
  name                   String
  slug                   String                  @unique
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  locations              Location[]
  users                  User[]
  customers              Customer[]
  pets                   Pet[]
  services               Service[]
  servicePrices          ServicePrice[]
  resources              Resource[]
  appointments           Appointment[]
  recurrenceSeries       RecurrenceSeries[]
  omieConnections        OmieConnection[]
  omieCustomerLinks      OmieCustomerLink[]
  omieSalesEvents        OmieSalesEvent[]
  messageCreditsWallets  MessageCreditsWallet[]
  notificationJobs       NotificationJob[]
  auditLogs              AuditLog[]
  billingSubscriptions   BillingSubscription[]
  contacts               CustomerContact[]
}

model Location {
  id           String        @id @default(uuid())
  tenantId     String
  name         String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  appointments Appointment[]
}

model User {
  id             String         @id @default(uuid())
  tenantId       String?
  email          String         @unique
  passwordHash   String
  name           String
  role           UserRole
  isActive       Boolean        @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  tenant         Tenant?        @relation(fields: [tenantId], references: [id])
  refreshTokens  RefreshToken[]
  loginLogs      LoginLog[]
}

enum UserRole {
  ADMIN
  STAFF
  GROOMER
  SUPER_ADMIN
}

model Customer {
  id           String             @id @default(uuid())
  tenantId     String
  name         String
  phone        String
  email        String?
  cpf          String?
  optInGlobal  Boolean            @default(true)
  isActive     Boolean            @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  tenant       Tenant             @relation(fields: [tenantId], references: [id])
  pets         Pet[]
  appointments Appointment[]
  omieLinks    OmieCustomerLink[]
  otpCodes     OtpCode[]
  refreshTokens RefreshToken[]
  loginLogs    LoginLog[]
  contacts     CustomerContact[]

  @@unique([tenantId, phone])
  @@index([tenantId, cpf])
}

model Pet {
  id           String        @id @default(uuid())
  tenantId     String
  customerId   String
  name         String
  species      Species
  lifeStatus   LifeStatus    @default(ALIVE)
  allowNotifications Boolean @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  customer     Customer      @relation(fields: [customerId], references: [id])
  appointments Appointment[]
}

enum LifeStatus {
  ALIVE
  DECEASED
}

enum Species {
  DOG
  CAT
}

model Service {
  id           String         @id @default(uuid())
  tenantId     String
  name         String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  prices       ServicePrice[]
  appointments Appointment[]
}

model ServicePrice {
  id        String   @id @default(uuid())
  tenantId  String
  serviceId String
  price     Decimal  @db.Decimal(10,2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  service   Service  @relation(fields: [serviceId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model Resource {
  id                   String                @id @default(uuid())
  tenantId             String
  name                 String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  appointmentResources AppointmentResource[]
}

model Appointment {
  id          String              @id @default(uuid())
  tenantId    String
  locationId  String
  customerId  String
  petId       String?
  serviceId   String?
  startsAt    DateTime
  endsAt      DateTime
  status      AppointmentStatus   @default(SCHEDULED)
  notes       String?
  cancelledAt DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  location    Location            @relation(fields: [locationId], references: [id])
  customer    Customer            @relation(fields: [customerId], references: [id])
  pet         Pet?                @relation(fields: [petId], references: [id])
  service     Service?            @relation(fields: [serviceId], references: [id])
  resources   AppointmentResource[]
  omieSalesEvents OmieSalesEvent[]

  @@index([tenantId, locationId, startsAt])
  @@index([tenantId, customerId, startsAt])
}

enum AppointmentStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
  DONE
  RESCHEDULED
  NO_SHOW
}

model AppointmentResource {
  id            String      @id @default(uuid())
  appointmentId String
  resourceId    String
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  resource      Resource    @relation(fields: [resourceId], references: [id])
}

model RecurrenceSeries {
  id        String   @id @default(uuid())
  tenantId  String
  rule      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model OmieConnection {
  id        String   @id @default(uuid())
  tenantId  String
  appKey    String
  appSecret String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model OmieCustomerLink {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  omieId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])
}

model OmieSalesEvent {
  id            String   @id @default(uuid())
  tenantId      String
  appointmentId String?
  status        String   @default("PENDING") // PENDING, SUCCESS, ERROR
  payload       Json
  errorMessage  String?
  omieOrderId   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
}

model MessageCreditsWallet {
  id           String                     @id @default(uuid())
  tenantId     String
  balance      Int                        @default(0)
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt
  tenant       Tenant                     @relation(fields: [tenantId], references: [id])
  transactions MessageCreditTransaction[]
}

model MessageCreditTransaction {
  id        String   @id @default(uuid())
  walletId  String
  amount    Int
  reason    String
  createdAt DateTime @default(now())
  wallet    MessageCreditsWallet @relation(fields: [walletId], references: [id])
}

model NotificationJob {
  id        String   @id @default(uuid())
  tenantId  String
  payload   Json
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String
  actorId   String?
  action    String
  payload   Json?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model BillingSubscription {
  id        String   @id @default(uuid())
  tenantId  String
  plan      String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model RefreshToken {
  id         String    @id @default(uuid())
  tokenHash  String
  jti        String
  userId     String?
  customerId String?
  revokedAt  DateTime?
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  replacedByTokenId String?
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([jti])
}

enum ActorType {
  USER
  CUSTOMER
}

model OtpCode {
  id           String   @id @default(uuid())
  customerId   String
  phone        String
  codeHash     String
  expiresAt    DateTime
  consumedAt   DateTime?
  attemptCount Int      @default(0)
  lockedUntil  DateTime?
  createdAt    DateTime @default(now())
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([customerId])
}

model LoginLog {
  id         String    @id @default(uuid())
  actorType  ActorType
  userId     String?
  customerId String?
  email      String?
  phone      String?
  ipAddress  String?
  userAgent  String?
  success    Boolean
  reason     String?
  createdAt  DateTime  @default(now())
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([customerId])
  @@index([createdAt])
}

model CustomerContact {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  name       String
  email      String?
  phone      String?
  birthDate  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])

  @@index([tenantId, customerId])
  @@index([tenantId, phone])
}
