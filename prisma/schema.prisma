model MessageCreditsWallet {
  id         String   @id @default(uuid())
  tenantId   String  @map("tenant_id")
  channel    Channel
  balance    Int      @default(0)
  updatedAt  DateTime @updatedAt @map("updated_at")
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  transactions MessageCreditTransaction[]
  @@unique([tenantId, channel])
  @@map("message_credits_wallet")
}

model MessageCreditTransaction {
  id         String   @id @default(uuid())
  tenantId   String  @map("tenant_id")
  channel    Channel
  type       TransactionType
  amount     Int
  reason     String
  createdAt  DateTime @default(now()) @map("created_at")
  walletId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  wallet     MessageCreditsWallet @relation(fields: [walletId], references: [id])
  @@map("message_credit_transaction")
}

enum Channel {
  SMS
  WHATSAPP
}

enum TransactionType {
  PURCHASE
  CONSUME
  ADJUSTMENT
  REFUND
}
model BillingPlan {
  code        String   @id
  name        String
  limits      Json
  priceCents  Int      @map("price_cents")
  active      Boolean  @default(true)
  subscriptions BillingSubscription[]
  @@map("billing_plan")
}

model BillingSubscription {
  id                      String   @id @default(uuid())
  tenantId                String  @map("tenant_id")
  planCode                String  @map("plan_code")
  status                  SubscriptionStatus @default(TRIAL)
  trialEndsAt             DateTime? @map("trial_ends_at")
  currentPeriodEnd        DateTime? @map("current_period_end")
  provider                String?
  providerSubscriptionId  String? @map("provider_subscription_id")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  tenant                  Tenant   @relation(fields: [tenantId], references: [id])
  plan                    BillingPlan @relation(fields: [planCode], references: [code])
  @@map("billing_subscription")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  SUSPENDED
  CANCELED
}
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                     String                  @id @default(uuid())
  name                   String
  slug                   String                  @unique
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  locations              Location[]
  users                  User[]
  customers              Customer[]
  pets                   Pet[]
  services               Service[]
  servicePrices          ServicePrice[]
  resources              Resource[]
  appointments           Appointment[]
  recurrenceSeries       RecurrenceSeries[]
  omieConnections        OmieConnection[]
  omieCustomerLinks      OmieCustomerLink[]
  omieSalesEvents        OmieSalesEvent[]
  messageCreditsWallets  MessageCreditsWallet[]
  messageCreditTransactions MessageCreditTransaction[]
  notificationJobs       NotificationJob[]
  auditLogs              AuditLog[]
  billingSubscriptions   BillingSubscription[]
  contacts               CustomerContact[]
  config                 TenantConfig?
}

model Location {
  id           String        @id @default(uuid())
  tenantId     String
  name         String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  appointments Appointment[]
}

model User {
  id             String         @id @default(uuid())
  tenantId       String?
  email          String         @unique
  passwordHash   String
  name           String
  role           UserRole
  isActive       Boolean        @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  tenant         Tenant?        @relation(fields: [tenantId], references: [id])
  refreshTokens  RefreshToken[]
  loginLogs      LoginLog[]
}

enum UserRole {
  ADMIN
  STAFF
  GROOMER
  SUPER_ADMIN
}

model Customer {
  id           String             @id @default(uuid())
  tenantId     String
  name         String
  phone        String
  email        String?
  cpf          String?
  optInGlobal  Boolean            @default(true)
  isActive     Boolean            @default(true)
  status       CustomerStatus     @default(ACTIVE)
  deletedAt    DateTime?          @map("deleted_at")
  lastLoginAt  DateTime?          @map("lastLoginAt")
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  tenant       Tenant             @relation(fields: [tenantId], references: [id])
  pets         Pet[]
  appointments Appointment[]
  omieLinks    OmieCustomerLink[]
  otpCodes     OtpCode[]
  refreshTokens RefreshToken[]
  loginLogs    LoginLog[]
  contacts     CustomerContact[]

  @@unique([tenantId, phone])
  @@index([tenantId, cpf])
  @@map("customer")
}

enum CustomerStatus {
  ACTIVE
  DELETED
}

model Pet {
  id           String        @id @default(uuid())
  tenantId     String
  customerId   String
  name         String
  species      Species
  lifeStatus   LifeStatus    @default(ALIVE)
  allowNotifications Boolean @default(true)
  isDeceased   Boolean       @default(false) @map("is_deceased")
  deceasedAt   DateTime?     @map("deceased_at")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  customer     Customer      @relation(fields: [customerId], references: [id])
  appointments Appointment[]
  @@map("pet")
}

enum LifeStatus {
  ALIVE
  DECEASED
}

enum Species {
  DOG
  CAT
}

model Service {
  id           String         @id @default(uuid())
  tenantId     String
  name         String
  description  String?
  baseDurationMinutes Int     @default(30)
  active       Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  prices       ServicePrice[]
  appointments Appointment[]

  @@unique([tenantId, name])
}

model ServicePrice {
  id        String   @id @default(uuid())
  tenantId  String
  serviceId String
  price     Decimal  @db.Decimal(10,2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  service   Service  @relation(fields: [serviceId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model Resource {
  id                   String                @id @default(uuid())
  tenantId             String
  name                 String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  appointmentResources AppointmentResource[]
}

model Appointment {
  id          String              @id @default(uuid())
  tenantId    String
  locationId  String
  customerId  String
  petId       String?
  serviceId   String?
  startsAt    DateTime
  endsAt      DateTime
  status      AppointmentStatus   @default(SCHEDULED)
  statusReason AppointmentStatusReason?
  notes       String?
  cancelledAt DateTime?
  recurrenceSeriesId String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  location    Location            @relation(fields: [locationId], references: [id])
  customer    Customer            @relation(fields: [customerId], references: [id])
  pet         Pet?                @relation(fields: [petId], references: [id])
  service     Service?            @relation(fields: [serviceId], references: [id])
  recurrenceSeries RecurrenceSeries? @relation(fields: [recurrenceSeriesId], references: [id])
  resources   AppointmentResource[]
  notificationJobs NotificationJob[]
  omieSalesEvents OmieSalesEvent[]

  @@index([tenantId, locationId, startsAt])
  @@index([tenantId, customerId, startsAt])
  @@index([recurrenceSeriesId])
  @@map("appointment")
}

enum AppointmentStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
  DONE
  RESCHEDULED
  NO_SHOW
}

enum AppointmentStatusReason {
  CUSTOMER_DELETED
  CANCELED_BY_ADMIN
  CANCELED_BY_CUSTOMER
  CANCELED_BY_SYSTEM
  OTHER
}

model AppointmentResource {
  id            String      @id @default(uuid())
  appointmentId String
  resourceId    String
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  resource      Resource    @relation(fields: [resourceId], references: [id])
}

model RecurrenceSeries {
  id        String   @id @default(uuid())
  tenantId  String
  frequency RecurrenceFrequency
  interval  Int?
  startAt   DateTime
  endAt     DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  appointments Appointment[]
  @@map("recurrence_series")
}
enum RecurrenceFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM_INTERVAL
}

model OmieConnection {
  id        String   @id @default(uuid())
  tenantId  String
  appKey    String
  appSecret String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model OmieCustomerLink {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  omieId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])
}

model OmieSalesEvent {
  id            String   @id @default(uuid())
  tenantId      String
  appointmentId String?
  status        String   @default("PENDING") // PENDING, SUCCESS, ERROR
  payload       Json
  errorMessage  String?
  omieOrderId   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
}


model NotificationJob {
  id               String   @id @default(uuid())
  tenantId         String
  appointmentId    String?
  channel          Channel
  payload          Json
  status           NotificationJobStatus @default(SCHEDULED)
  errorMessage     String?
  providerMessageId String?
  queueJobId       String?
  sentAt           DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  appointment      Appointment? @relation(fields: [appointmentId], references: [id])
  @@map("notification_job")
}

enum NotificationJobStatus {
  SCHEDULED
  SENT
  ERROR
  CANCELLED
}

model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String
  actorId   String?
  action    String
  payload   Json?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}


model TenantConfig {
  id                 String   @id @default(uuid())
  tenantId           String   @unique
  reminderEnabled    Boolean  @default(true)
  reminderHoursBefore Int     @default(24)
  cancelWindowHours  Int      @default(2)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  tenant             Tenant   @relation(fields: [tenantId], references: [id])
}

model RefreshToken {
  id         String    @id @default(uuid())
  tokenHash  String
  jti        String
  userId     String?
  customerId String?
  revokedAt  DateTime?
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  replacedByTokenId String?
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([jti])
}

enum ActorType {
  USER
  CUSTOMER
}

model OtpCode {
  id           String   @id @default(uuid())
  customerId   String
  phone        String
  codeHash     String
  expiresAt    DateTime
  consumedAt   DateTime?
  attemptCount Int      @default(0)
  lockedUntil  DateTime?
  createdAt    DateTime @default(now())
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([customerId])
}

enum NotificationType {
  REMINDER
  NO_SHOW_FOLLOWUP
  OTP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

model LoginLog {
  id         String    @id @default(uuid())
  actorType  ActorType
  userId     String?
  customerId String?
  email      String?
  phone      String?
  ipAddress  String?
  userAgent  String?
  success    Boolean
  reason     String?
  createdAt  DateTime  @default(now())
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([customerId])
  @@index([createdAt])
}

model CustomerContact {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  name       String
  email      String?
  phone      String?
  birthDate  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])

  @@index([tenantId, customerId])
  @@index([tenantId, phone])
}
