generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model MessageCreditsWallet {
  id           String                     @id @default(uuid())
  tenantId     String                     @map("tenant_id")
  channel      Channel
  balance      Int                        @default(0)
  updatedAt    DateTime                   @updatedAt @map("updated_at")
  transactions MessageCreditTransaction[]
  tenant       Tenant                     @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, channel])
  @@map("message_credits_wallet")
}

model MessageCreditTransaction {
  id        String               @id @default(uuid())
  tenantId  String               @map("tenant_id")
  channel   Channel
  type      TransactionType
  amount    Int
  reason    String
  createdAt DateTime             @default(now()) @map("created_at")
  walletId  String
  tenant    Tenant               @relation(fields: [tenantId], references: [id])
  wallet    MessageCreditsWallet @relation(fields: [walletId], references: [id])

  @@map("message_credit_transaction")
}

model BillingPlan {
  code          String                @id
  name          String
  limits        Json
  priceCents    Int                   @map("price_cents")
  active        Boolean               @default(true)
  subscriptions BillingSubscription[]

  @@map("billing_plan")
}

model BillingSubscription {
  id                     String             @id @default(uuid())
  tenantId               String             @map("tenant_id")
  planCode               String             @map("plan_code")
  status                 SubscriptionStatus @default(TRIAL)
  trialEndsAt            DateTime?          @map("trial_ends_at")
  currentPeriodEnd       DateTime?          @map("current_period_end")
  provider               String?
  providerSubscriptionId String?            @map("provider_subscription_id")
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")
  plan                   BillingPlan        @relation(fields: [planCode], references: [code])
  tenant                 Tenant             @relation(fields: [tenantId], references: [id])

  @@map("billing_subscription")
}

model Tenant {
  id                        String                     @id @default(uuid())
  name                      String
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  isActive                  Boolean                    @default(true)
  slug                      String                     @unique
  auditLogs                 AuditLog[]
  contacts                  CustomerContact[]
  locations                 Location[]
  omieConnections           OmieConnection[]
  omieCustomerLinks         OmieCustomerLink[]
  omieSalesEvents           OmieSalesEvent[]
  resources                 Resource[]
  services                  Service[]
  servicePrices             ServicePrice[]
  config                    TenantConfig?
  users                     User[]
  appointments              Appointment[]
  billingSubscriptions      BillingSubscription[]
  customers                 Customer[]
  messageCreditTransactions MessageCreditTransaction[]
  messageCreditsWallets     MessageCreditsWallet[]
  notificationJobs          NotificationJob[]
  pets                      Pet[]
  recurrenceSeries          RecurrenceSeries[]
}

model Location {
  id           String        @id @default(uuid())
  tenantId     String
  name         String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  appointments Appointment[]
}

model User {
  id            String         @id @default(uuid())
  tenantId      String?
  email         String         @unique
  name          String
  role          UserRole
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isActive      Boolean        @default(true)
  lastLoginAt   DateTime?
  passwordHash  String
  loginLogs     LoginLog[]
  refreshTokens RefreshToken[]
  tenant        Tenant?        @relation(fields: [tenantId], references: [id])
}

model Customer {
  id            String             @id @default(uuid())
  tenantId      String
  name          String
  phone         String
  email         String?
  cpf           String?
  optInGlobal   Boolean            @default(true)
  isActive      Boolean            @default(true)
  status        CustomerStatus     @default(ACTIVE)
  deletedAt     DateTime?          @map("deleted_at")
  lastLoginAt   DateTime?          @map("lastLoginAt")
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  contacts      CustomerContact[]
  loginLogs     LoginLog[]
  omieLinks     OmieCustomerLink[]
  otpCodes      OtpCode[]
  refreshTokens RefreshToken[]
  appointments  Appointment[]
  tenant        Tenant             @relation(fields: [tenantId], references: [id])
  pets          Pet[]

  @@unique([tenantId, phone])
  @@index([tenantId, cpf])
  @@map("customer")
}

model Pet {
  id                 String        @id @default(uuid())
  tenantId           String
  customerId         String
  name               String
  species            Species
  lifeStatus         LifeStatus    @default(ALIVE)
  allowNotifications Boolean       @default(true)
  isDeceased         Boolean       @default(false) @map("is_deceased")
  deceasedAt         DateTime?     @map("deceased_at")
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  appointments       Appointment[]
  customer           Customer      @relation(fields: [customerId], references: [id])
  tenant             Tenant        @relation(fields: [tenantId], references: [id])

  @@map("pet")
}

model Service {
  id                  String         @id @default(uuid())
  tenantId            String
  name                String
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  description         String?
  baseDurationMinutes Int            @default(30)
  active              Boolean        @default(true)
  tenant              Tenant         @relation(fields: [tenantId], references: [id])
  prices              ServicePrice[]
  appointments        Appointment[]

  @@unique([tenantId, name])
}

model ServicePrice {
  id        String   @id @default(uuid())
  tenantId  String
  serviceId String
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  service   Service  @relation(fields: [serviceId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model Resource {
  id                   String                @id @default(uuid())
  tenantId             String
  name                 String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  appointmentResources AppointmentResource[]
  tenant               Tenant                @relation(fields: [tenantId], references: [id])
}

model Appointment {
  id                 String                   @id @default(uuid())
  tenantId           String
  locationId         String
  customerId         String
  petId              String?
  serviceId          String?
  startsAt           DateTime
  endsAt             DateTime
  status             AppointmentStatus        @default(SCHEDULED)
  statusReason       AppointmentStatusReason?
  notes              String?
  cancelledAt        DateTime?
  recurrenceSeriesId String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  resources          AppointmentResource[]
  omieSalesEvents    OmieSalesEvent[]
  customer           Customer                 @relation(fields: [customerId], references: [id])
  location           Location                 @relation(fields: [locationId], references: [id])
  pet                Pet?                     @relation(fields: [petId], references: [id])
  recurrenceSeries   RecurrenceSeries?        @relation(fields: [recurrenceSeriesId], references: [id])
  service            Service?                 @relation(fields: [serviceId], references: [id])
  tenant             Tenant                   @relation(fields: [tenantId], references: [id])
  notificationJobs   NotificationJob[]

  @@index([tenantId, locationId, startsAt])
  @@index([tenantId, customerId, startsAt])
  @@index([recurrenceSeriesId])
  @@map("appointment")
}

model AppointmentResource {
  id            String      @id @default(uuid())
  appointmentId String
  resourceId    String
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  resource      Resource    @relation(fields: [resourceId], references: [id])
}

model RecurrenceSeries {
  id           String              @id @default(uuid())
  tenantId     String
  frequency    RecurrenceFrequency
  interval     Int?
  startAt      DateTime
  endAt        DateTime
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  appointments Appointment[]
  tenant       Tenant              @relation(fields: [tenantId], references: [id])

  @@map("recurrence_series")
}

model OmieConnection {
  id        String   @id @default(uuid())
  tenantId  String
  appKey    String
  appSecret String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model OmieCustomerLink {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  omieId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  customer   Customer @relation(fields: [customerId], references: [id])
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
}

model OmieSalesEvent {
  id            String       @id @default(uuid())
  tenantId      String
  payload       Json
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  appointmentId String?
  errorMessage  String?
  omieOrderId   String?
  status        String       @default("PENDING")
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  tenant        Tenant       @relation(fields: [tenantId], references: [id])
}

model NotificationJob {
  id                String                @id @default(uuid())
  tenantId          String
  appointmentId     String?
  channel           Channel
  payload           Json
  status            NotificationJobStatus @default(SCHEDULED)
  errorMessage      String?
  providerMessageId String?
  queueJobId        String?
  sentAt            DateTime?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  appointment       Appointment?          @relation(fields: [appointmentId], references: [id])
  tenant            Tenant                @relation(fields: [tenantId], references: [id])

  @@map("notification_job")
}

model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String
  actorId   String?
  action    String
  payload   Json?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model TenantConfig {
  id                  String   @id @default(uuid())
  tenantId            String   @unique
  reminderEnabled     Boolean  @default(true)
  reminderHoursBefore Int      @default(24)
  cancelWindowHours   Int      @default(2)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  tenant              Tenant   @relation(fields: [tenantId], references: [id])
}

model RefreshToken {
  id                String    @id @default(uuid())
  tokenHash         String
  jti               String
  userId            String?
  customerId        String?
  revokedAt         DateTime?
  replacedByTokenId String?
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  customer          Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user              User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([jti])
}

model OtpCode {
  id           String    @id @default(uuid())
  customerId   String
  phone        String
  codeHash     String
  expiresAt    DateTime
  consumedAt   DateTime?
  attemptCount Int       @default(0)
  lockedUntil  DateTime?
  createdAt    DateTime  @default(now())
  customer     Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([customerId])
}

model LoginLog {
  id         String    @id @default(uuid())
  actorType  ActorType
  userId     String?
  customerId String?
  email      String?
  phone      String?
  ipAddress  String?
  userAgent  String?
  success    Boolean
  reason     String?
  createdAt  DateTime  @default(now())
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([customerId])
  @@index([createdAt])
}

model CustomerContact {
  id         String    @id @default(uuid())
  tenantId   String
  customerId String
  name       String
  email      String?
  phone      String?
  birthDate  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  customer   Customer  @relation(fields: [customerId], references: [id])
  tenant     Tenant    @relation(fields: [tenantId], references: [id])

  @@index([tenantId, customerId])
  @@index([tenantId, phone])
}

enum Channel {
  SMS
  WHATSAPP
}

enum TransactionType {
  PURCHASE
  CONSUME
  ADJUSTMENT
  REFUND
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  SUSPENDED
  CANCELED
}

enum UserRole {
  ADMIN
  STAFF
  GROOMER
  SUPER_ADMIN
}

enum CustomerStatus {
  ACTIVE
  DELETED
}

enum LifeStatus {
  ALIVE
  DECEASED
}

enum Species {
  DOG
  CAT
}

enum AppointmentStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
  DONE
  RESCHEDULED
  NO_SHOW
}

enum AppointmentStatusReason {
  CUSTOMER_DELETED
  CANCELED_BY_ADMIN
  CANCELED_BY_CUSTOMER
  CANCELED_BY_SYSTEM
  OTHER
}

enum RecurrenceFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM_INTERVAL
}

enum NotificationJobStatus {
  SCHEDULED
  SENT
  ERROR
  CANCELLED
}

enum ActorType {
  USER
  CUSTOMER
}

enum NotificationType {
  REMINDER
  NO_SHOW_FOLLOWUP
  OTP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}
